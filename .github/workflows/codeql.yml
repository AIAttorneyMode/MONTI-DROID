name: "Ultimate CodeQL (MontiDroid) ‚Äî AuthenticateOnlyMONTI"

on:
  push:
    branches: [ "master", "main" ]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
  pull_request:
    branches: [ "master", "main" ]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
  schedule:
    - cron: "18 22 * * 1"
  workflow_dispatch:
    inputs:
      force_analysis:
        description: "Force full analysis (bypass caching)"
        required: false
        default: "false"
        type: boolean

# Default to minimal permissions
permissions: {}

# Prevent concurrent runs on same ref
concurrency:
  group: "codeql-ultimate-${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

env:
  # Ultimate workflow environment
  MONTI_PROJECT: "MontiDroid"
  SECURITY_LEVEL: "ULTIMATE"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true"

jobs:
  # Pre-flight security check
  authenticate-monti:
    name: "üîê Authenticate MONTI Context"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      is-authorized: ${{ steps.auth-check.outputs.authorized }}
      scan-languages: ${{ steps.lang-detect.outputs.languages }}
    
    steps:
      - name: "Verify Repository Context"
        id: auth-check
        run: |
          # Only allow execution in MONTI-controlled contexts
          if [[ "${{ github.repository_owner }}" =~ ^(MontiAI|MONTI-AIRFORCE|AIAttorneymode|Digitalvirtuallife|JOHNUNO11)$ ]]; then
            echo "‚úÖ Authorized MONTI context: ${{ github.repository_owner }}"
            echo "authorized=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå UNAUTHORIZED: Repository owner '${{ github.repository_owner }}' not in MONTI allowlist"
            echo "authorized=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: "Detect Languages for Analysis"
        id: lang-detect
        run: |
          # Ultimate language detection based on repo context
          languages='["java-kotlin", "python"]'
          echo "languages=${languages}" >> $GITHUB_OUTPUT
          echo "üéØ Languages detected: ${languages}"

  # Ultimate CodeQL Analysis
  ultimate-analyze:
    name: "üöÄ Ultimate Analysis (${{ matrix.language }})"
    runs-on: ${{ matrix.language == 'swift' && 'macos-latest' || 'ubuntu-latest' }}
    needs: authenticate-monti
    if: needs.authenticate-monti.outputs.is-authorized == 'true'
    timeout-minutes: 60

    permissions:
      # Minimal required permissions for CodeQL
      security-events: write
      contents: read
      actions: read
      packages: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - language: java-kotlin
            build-mode: autobuild
            queries: "security-extended,security-and-quality"
            runner-size: "large"
          - language: python
            build-mode: none
            queries: "security-extended,security-and-quality"
            runner-size: "standard"

    steps:
      - name: "üîç Checkout Repository (Verified)"
        uses: actions/checkout@v4
        with:
          # Fetch full history for better analysis
          fetch-depth: 0
          # Only checkout from trusted refs
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: "üõ°Ô∏è Security Context Validation"
        run: |
          echo "üîê MONTI Security Context:"
          echo "  Repository: ${{ github.repository }}"
          echo "  Owner: ${{ github.repository_owner }}"
          echo "  Event: ${{ github.event_name }}"
          echo "  Ref: ${{ github.ref }}"
          echo "  SHA: ${{ github.sha }}"
          echo "  Language: ${{ matrix.language }}"
          echo "  Build Mode: ${{ matrix.build-mode }}"

      - name: "‚òï Setup Java (for Kotlin/Android)"
        if: matrix.language == 'java-kotlin'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: "üêç Setup Python (Ultimate)"
        if: matrix.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: "üîß Pre-build Setup (Android/Gradle)"
        if: matrix.language == 'java-kotlin'
        run: |
          # Make gradlew executable
          chmod +x ./gradlew || true
          
          # Validate Gradle wrapper
          if [ -f "./gradlew" ]; then
            echo "‚úÖ Gradle wrapper found"
            ./gradlew --version
          else
            echo "‚ö†Ô∏è No Gradle wrapper found, using system gradle"
          fi

      - name: "üöÄ Initialize Ultimate CodeQL"
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}
          queries: ${{ matrix.queries }}
          # Ultimate query configuration
          config: |
            name: "Ultimate MONTI CodeQL Config"
            queries:
              - uses: ${{ matrix.queries }}
            paths-ignore:
              - "test/**"
              - "tests/**"
              - "**/*test*/**"
              - "**/build/**"
              - ".gradle/**"
            paths:
              - "src/**"
              - "app/**"
              - "lib/**"

      - name: "üî® Manual Build (if required)"
        if: matrix.build-mode == 'manual'
        shell: bash
        run: |
          echo "üî® Running manual build for ${{ matrix.language }}"
          
          if [ -f "./gradlew" ]; then
            echo "Building Android/Gradle project..."
            ./gradlew clean assembleDebug --no-daemon --stacktrace
          elif [ -f "setup.py" ]; then
            echo "Building Python project..."
            pip install -e .
          elif [ -f "requirements.txt" ]; then
            echo "Installing Python dependencies..."
            pip install -r requirements.txt
          else
            echo "No recognized build system found"
            exit 1
          fi

      - name: "üéØ Perform Ultimate CodeQL Analysis"
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{ matrix.language }}"
          upload: true
          # Ultimate analysis configuration
          checkout-path: ${{ github.workspace }}

      - name: "üìä Analysis Summary"
        run: |
          echo "‚úÖ Ultimate CodeQL Analysis Complete"
          echo "  Language: ${{ matrix.language }}"
          echo "  Build Mode: ${{ matrix.build-mode }}"
          echo "  Queries: ${{ matrix.queries }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Commit: ${{ github.sha }}"

  # Post-analysis security validation
  ultimate-validation:
    name: "üõ°Ô∏è Ultimate Security Validation"
    runs-on: ubuntu-latest
    needs: [authenticate-monti, ultimate-analyze]
    if: always() && needs.authenticate-monti.outputs.is-authorized == 'true'
    timeout-minutes: 10

    steps:
      - name: "üìã Analysis Results Summary"
        run: |
          echo "üéØ ULTIMATE CODEQL ANALYSIS COMPLETE"
          echo "=================================="
          echo "Project: ${{ env.MONTI_PROJECT }}"
          echo "Security Level: ${{ env.SECURITY_LEVEL }}"
          echo "Repository: ${{ github.repository }}"
          echo "Owner: ${{ github.repository_owner }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=================================="

      - name: "üîê MONTI Authentication Status"
        run: |
          echo "‚úÖ MONTI Authentication: VERIFIED"
          echo "‚úÖ Repository Owner: AUTHORIZED"
          echo "‚úÖ Security Context: VALIDATED"
          echo "‚úÖ Analysis: COMPLETED"

      - name: "üìà Workflow Status"
        run: |
          if [[ "${{ needs.ultimate-analyze.result }}" == "success" ]]; then
            echo "üéâ ALL ANALYSES SUCCESSFUL"
            exit 0
          else
            echo "‚ùå ANALYSIS FAILURES DETECTED"
            echo "Check individual job results for details"
            exit 1
          fi
